package net.rezmason.engram {		import flash.display.Shape;	import flash.display.Sprite;	import flash.display.Stage;	import flash.events.Event;	import flash.geom.Point;	import flash.geom.Rectangle;		import com.robertpenner.easing.Linear;	import gs.TweenLite;		import net.rezmason.display.ColorSprite;	import net.rezmason.gui.GUIButton;	import net.rezmason.display.Peeler;	import net.rezmason.media.SoundManager;	internal class Prompt extends ColorSprite {				// CLASS PROPERTIES		public static const OFFSCREEN:String = "offScreen";		public static const ONSCREEN:String = "onscreen";		private static const OFFSCREEN_EVENT:Event = new Event(OFFSCREEN);		private static const ONSCREEN_EVENT:Event = new Event(ONSCREEN);		private static const MARGIN:int = 50, CENTER_MARGIN:int = 100;		private static const ANGLE_RANGE:Number = 15;		internal static const DISAPPEAR:String = "disappear";				// INSTANCE PROPERTIES						private var alertBox:AlertGuts = new PromptGuts() as AlertGuts;		private var alertSurface:PromptSurface = new PromptSurface(500, 200);		private var _alertType:AlertType;		private var _palette:Array;				private var _stage:Stage;		private var peeler:Peeler;		private var sticker:Sprite = new Sprite;		private var stickerBack:Shape = new Shape;		private var sill1:Shape = new Shape, sill2:Shape = new Shape;		private var bounds:Rectangle;				private var timing:Number = 1;		private var tweenVars:Object = {ease:Linear.easeNone};		private var peelOrigin:Point = new Point, peelOriginLocal:Point;		private var peelDestination:Point = new Point, peelDestinationLocal:Point;				private var _disppearing:Boolean = false;		private var _onscreen:Boolean = false;		private var soundManager:SoundManager = SoundManager.INSTANCE;				// CONSTRUCTOR		public function Prompt(stg:Stage):void {						_stage = stg;						sticker.addChild(alertSurface);			sticker.addChild(alertBox);			addColorChild(alertSurface);			addColorChild(alertBox);						addChild(sticker);						peeler = new Peeler(sticker, stickerBack, sill1, sill2);			peeler.addEventListener(Peeler.PEELING, startPeelSound);			peeler.addEventListener(Peeler.NOT_PEELING, stopPeelSound);			peeler.shiny = false;			addChild(peeler);						alertType = AlertType.DECISION;	//AlertType.DECISION;						alertBox.addEventListener(DISAPPEAR, disappear);						mouseEnabled = mouseChildren = false;		}				// GETTERS & SETTERS				public function get defaultAffirmative():GUIButton {			return alertBox.defaultAffirmative;		}				public function get defaultNegative():GUIButton {			return alertBox.defaultNegative;		}				internal function get alertType():AlertType {			return _alertType;		}		internal function get onscreen():Boolean {			return _onscreen;		}				internal function set alertType(value:AlertType):void {			_alertType = value;			alertBox.symbol = _alertType.symbol;			_palette = GamePalette.ALERT_PALETTES[alertType.paletteIndex].slice();			alertBox.whiteText = !isBright(_palette[0]);			setColors(_palette);			alertSurface.textureAlpha = _alertType.textureAlpha;		}				// INTERNAL METHODS				internal function show(title:String = "", messsage:String = "", leftButtons:Array = null, rightButtons:Array = null, 							   defaultAffirmative:String = null, defaultNegative:String = null, prox:Point = null):void {			alertBox.show(title, messsage, leftButtons, rightButtons, defaultAffirmative, defaultNegative);			alertBox.setColors(_palette);			alertSurface.redraw(alertBox.width + 2 * AlertGuts.MARGIN, alertBox.height + 2 * AlertGuts.MARGIN + AlertGuts.TOP_MARGIN);						peeler.x = 0;			peeler.y = 0;						peeler.rotation = (Math.random() * 2 - 1) * ANGLE_RANGE;			bounds = sticker.getBounds(this);						if (prox) {				peeler.x = prox.x - bounds.x - bounds.width  / 2;				peeler.x = Math.min(peeler.x, _stage.stageWidth  - MARGIN * 2 - bounds.width  - bounds.x + MARGIN);				peeler.x = Math.max(peeler.x, -bounds.x + MARGIN);								peeler.y = prox.y - bounds.y - bounds.height / 2;				peeler.y = Math.min(peeler.y, _stage.stageHeight - MARGIN * 2 - bounds.height - bounds.y + MARGIN);				peeler.y = Math.max(peeler.y, -bounds.y + MARGIN);			} else {				peeler.x = Math.random() * (_stage.stageWidth  - CENTER_MARGIN * 2 - bounds.width ) - bounds.x + CENTER_MARGIN;				peeler.y = Math.random() * (_stage.stageHeight - CENTER_MARGIN * 2 - bounds.height) - bounds.y + CENTER_MARGIN;				}						alertSurface.makeStickerBack(stickerBack);			alertSurface.makeSillhouette(sill1);			alertSurface.makeSillhouette(sill2);						peeler.update();						setupTween();			tweenVars.onComplete = doneAppearing;			TweenLite.from(peeler, timing, tweenVars);			_onscreen = true;			dispatchEvent(ONSCREEN_EVENT);		}				internal function resize(w:int, h:int):void {			alertSurface.redraw(w, h);		}				internal function rerez(ratio:Number = 1):void {			alertSurface.rerez(ratio);		}				// PRIVATE METHODS				private function isBright(color:uint):Boolean {			return ((color >> 16) & 0xFF) + ((color >> 8) & 0xFF) + (color & 0xFF) > 0xE0;		}				private function disappear(event:Event = null):void {			_disppearing = true;			mouseEnabled = mouseChildren = false;			soundManager.play("buttonSound");			setupTween();			peeler.axisR += 180;			//tweenVars.axisR += 180;			tweenVars.onComplete = doneDisappearing;			TweenLite.to(peeler, timing, tweenVars);		}				private function setupTween():void {			TweenLite.killTweensOf(peeler);						if (Math.random() > 0.5) {				peelOrigin.x = (Math.random() > 0.5 ? -bounds.width  - MARGIN : _stage.stageWidth  + MARGIN) - bounds.x;				peelOrigin.y = Math.random() * (_stage.stageHeight - bounds.height) - bounds.y;			} else {					peelOrigin.x = Math.random() * (_stage.stageWidth  - bounds.width ) - bounds.x;				peelOrigin.y = (Math.random() > 0.5 ? -bounds.height - MARGIN : _stage.stageHeight + MARGIN) - bounds.y;			}						peelOriginLocal = peeler.globalToLocal(localToGlobal(peelOrigin));						peeler.axisX = peelOriginLocal.x;			peeler.axisY = peelOriginLocal.y;						peelDestination.x = _stage.stageWidth  - peelOrigin.x;			peelDestination.y = _stage.stageHeight - peelOrigin.y;						peelDestinationLocal = peeler.globalToLocal(localToGlobal(peelDestination));						tweenVars.axisX = peelDestinationLocal.x;			tweenVars.axisY = peelDestinationLocal.y;						peeler.axisR = Math.atan2(peelOrigin.y - peelDestination.y, peelOrigin.x - peelDestination.x) * 180 / Math.PI;			peeler.axisR -= peeler.rotation;						//tweenVars.axisR = peeler.axisR + Math.random() * 60;		}				private function doneAppearing():void {			mouseEnabled = mouseChildren = true;		}				private function doneDisappearing():void {			_disppearing = false;			alertBox.callFunction();			_onscreen = false;			dispatchEvent(OFFSCREEN_EVENT);		}				private function startPeelSound(event:Event = null):void {			if (_disppearing) {				soundManager.play("peelSound", 1);			} else {				soundManager.play("stickerSound", 1);			}		}				private function stopPeelSound(event:Event = null):void {			soundManager.stopChannel(1);		}	}}