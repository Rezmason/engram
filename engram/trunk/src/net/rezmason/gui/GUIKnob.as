package net.rezmason.gui {		// IMPORT STATEMENTS	import flash.display.DisplayObject;	import flash.display.Stage;	import flash.events.Event;	import flash.events.MouseEvent;		public class GUIKnob extends GUIAbstract {				// CLASS PROPERTIES		protected var CHANGE_EVENT:GUIEvent = new GUIEvent(Event.CHANGE);				// INSTANCE PROPERTIES		protected var _draggingDial:Boolean = false;		protected var _defaultRotation:Number;		protected var _position:Number;		protected var _rotation:Number;		protected var _minRotation:Number, _maxRotation:Number;		protected var grasp:Number, graspAngle:Number;		protected var _dial:DisplayObject;		protected var _stage:Stage;				// CONSTRUCTOR		public function GUIKnob():void {						super(GUIAbstractEnforcer.INSTANCE);						_rotation ||= 0;			_defaultRotation ||= 0;			_minRotation ||= -360;			_maxRotation ||= 360;						if (!_dial) {				expectedChildren["dial"] = DisplayObject;			}						verifyChildren(this);						if (!_dial) {				_dial = dial;				addColorChild(dial, 1);			}						buttonMode = true;			useHandCursor = true;						_dial.addEventListener(MouseEvent.MOUSE_DOWN, grabDial);						position = defaultPosition;						if (stage) {				addStageListeners();			} else {				addEventListener(Event.ADDED_TO_STAGE, addStageListeners);			}		}				// GETTERS & SETTERS				public function get defaultPosition():Number {			return _defaultRotation;		}				public function set defaultPosition(value:Number):void {			_defaultRotation = value;		}				public function get minPosition():Number {			return _minRotation;		}				public function set minPosition(value:Number):void {			_minRotation = value;		}				public function get maxPosition():Number {			return _maxRotation;		}				public function set maxPosition(value:Number):void {			_maxRotation = value;		}				public function get position():Number {			return _position;		}				public function set position(value:Number):void {			_position = value;		}				// PUBLIC METHODS				public function letGo(event:MouseEvent = null):void {			trace("letGo");			if (_draggingDial) {				dropDial(event);			}		}						// PRIVATE & PROTECTED METHODS				protected function addStageListeners(event:Event = null):void {			_stage = stage;			_stage.addEventListener(MouseEvent.MOUSE_UP, letGo);			removeEventListener(Event.ADDED_TO_STAGE, addStageListeners);						position = defaultPosition;		}				protected function grabDial(event:Event):void {			if (_stage) {				_draggingDial = true;				grasp = _rotation;				graspAngle = Math.atan2(mouseY - _dial.y, mouseX - _dial.x) * 180 / Math.PI;				_stage.addEventListener(MouseEvent.MOUSE_MOVE, dragDial);			}		}				protected function dropDial(event:Event):void {			if (_stage) {				_draggingDial = false;				dragDial(event);				_stage.removeEventListener(MouseEvent.MOUSE_MOVE, dragDial);			}		}				protected function dragDial(event:Event):void {			var diff:Number = _rotation;			_rotation = Math.atan2(mouseY - _dial.y, mouseX - _dial.x) * 180 / Math.PI - graspAngle + grasp;			diff = _rotation - diff;						while (diff > 180) {				_rotation -= 360;				diff -= 360;			}			while (diff < -180) {				_rotation += 360;				diff += 360;			}			_rotation = Math.min(_maxRotation, Math.max(_minRotation, _rotation));			_dial.rotation = _rotation;			_position = _rotation;			dispatchChange();		}				protected function dispatchChange():void {			CHANGE_EVENT.position = _position;			trace(_position);			dispatchEvent(CHANGE_EVENT);		}	}}