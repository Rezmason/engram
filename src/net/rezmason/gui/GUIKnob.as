package net.rezmason.gui {		// IMPORT STATEMENTS	import flash.display.DisplayObject;	import flash.display.Stage;	import flash.events.Event;	import flash.events.MouseEvent;		public class GUIKnob extends GUIAbstract {				// CLASS PROPERTIES		protected var CHANGE_EVENT:GUIEvent = new GUIEvent(Event.CHANGE);				// INSTANCE PROPERTIES		protected var _draggingDial:Boolean = false;		protected var _defaultRotation:Number;		protected var _rotation:Number;		protected var _minRotation:Number, _maxRotation:Number;		protected var grasp:Number, graspAngle:Number;		protected var _dial:DisplayObject;		protected var _stage:Stage;				// CONSTRUCTOR		public function GUIKnob():void {						super(GUIAbstractEnforcer.INSTANCE);						_minRotation ||= -100 - 90;			_defaultRotation ||= _minRotation;			_maxRotation ||=  100 - 90;			_rotation = _defaultRotation;						if (!_dial) {				expectedChildren["dial"] = DisplayObject;			}						verifyChildren(this);						if (!_dial) {				_dial = dial;				addColorChild(dial, 1);			}						buttonMode = true;			useHandCursor = true;						_dial.addEventListener(MouseEvent.MOUSE_DOWN, grabDial);						if (stage) {				addStageListeners();			} else {				addEventListener(Event.ADDED_TO_STAGE, addStageListeners);			}		}				// GETTERS & SETTERS				public function get defaultPosition():Number {			return (_defaultRotation + 90) / 360;		}				public function set defaultPosition(value:Number):void {			_defaultRotation = value * 360 - 90;			_defaultRotation = Math.min(_maxRotation, Math.max(_minRotation, _defaultRotation));		}				public function get minPosition():Number {			return (_minRotation + 90) / 360;		}				public function set minPosition(value:Number):void {			_minRotation = value * 360 - 90;			if (_minRotation > _maxRotation) {				_minRotation = _maxRotation;				_maxRotation = value * 360 - 90;			}		}				public function get maxPosition():Number {			return (_maxRotation + 90) / 360;		}				public function set maxPosition(value:Number):void {			_maxRotation = value * 360 - 90;			if (_minRotation > _maxRotation) {				_maxRotation = _minRotation;				_minRotation = value * 360 - 90;			}		}				public function get position():Number {			return (_rotation + 90) / 360;		}				public function set position(value:Number):void {			_rotation = (value * 360 - 90) || _defaultRotation;			_rotation = Math.min(_maxRotation, Math.max(_minRotation, _rotation));		}				// PUBLIC METHODS				public function letGo(event:MouseEvent = null):void {			trace("letGo");			if (_draggingDial) {				dropDial(event);			}		}						// PRIVATE & PROTECTED METHODS				protected function addStageListeners(event:Event = null):void {			_stage = stage;			_stage.addEventListener(MouseEvent.MOUSE_UP, letGo);			removeEventListener(Event.ADDED_TO_STAGE, addStageListeners);			_dial.rotation = _rotation;		}				protected function grabDial(event:Event):void {			if (_stage) {				_draggingDial = true;				grasp = _rotation;				graspAngle = Math.atan2(mouseY - _dial.y, mouseX - _dial.x) * 180 / Math.PI;				_stage.addEventListener(MouseEvent.MOUSE_MOVE, dragDial);			}		}				protected function dropDial(event:Event):void {			if (_stage) {				_draggingDial = false;				dragDial(event);				_stage.removeEventListener(MouseEvent.MOUSE_MOVE, dragDial);			}		}				protected function dragDial(event:Event):void {			var diff:Number = _rotation;			_rotation = Math.atan2(mouseY - _dial.y, mouseX - _dial.x) * 180 / Math.PI - graspAngle + grasp;			diff = _rotation - diff;						while (diff > 180) {				_rotation -= 360;				diff -= 360;			}						while (diff < -180) {				_rotation += 360;				diff += 360;			}			_rotation = Math.min(_maxRotation, Math.max(_minRotation, _rotation));			_dial.rotation = _rotation;			dispatchChange();		}				protected function dispatchChange():void {			CHANGE_EVENT.position = position;			dispatchEvent(CHANGE_EVENT);		}	}}